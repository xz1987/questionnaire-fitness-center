# 🔍 数据未保存到 Google Sheets 排查指南

## 📋 快速检查清单

### 1. 检查 Apps Script 执行日志（最重要）

这是找出问题的最直接方法：

1. **打开 Google Apps Script**
   - 访问：https://script.google.com/
   - 找到你的项目

2. **查看执行日志**
   - 点击左侧菜单 **"执行"**（Executions）
   - 或：**查看** → **执行日志**
   - 找到最近的执行记录

3. **查看日志内容**
   - 点击最近的执行记录
   - 查看日志输出，应该看到：
     ```
     === Data Receiving Debug ===
     e.postData exists: yes/no
     e.parameter exists: yes/no
     ...
     === Data Parsed Successfully ===
     Data keys: timestamp, overall_satisfaction, ...
     ```

4. **检查是否有错误**
   - 如果看到错误信息，记录下来
   - 常见错误：
     - "No data received" - 数据未收到
     - "Failed to parse data" - 数据解析失败
     - "Failed to access spreadsheet" - Sheet 访问失败

### 2. 检查 Web App 部署设置

1. **打开部署设置**
   - Apps Script → **部署** → 找到现有部署
   - 点击 **编辑**（铅笔图标）

2. **确认设置**
   - **执行身份**：我
   - **具有访问权限的用户**：**任何人** ⬅️ 这个很重要！

3. **如果修改了设置**
   - 点击 **部署**（会创建新版本）
   - 等待几秒钟让新版本生效

### 3. 检查 SPREADSHEET_ID

1. **打开 Code.gs**
   - 找到这一行：
     ```javascript
     const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';
     ```

2. **确认 ID 正确**
   - 打开你的 Google Sheets
   - 从 URL 中复制 ID
   - URL 格式：`https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit`
   - 确保 Code.gs 中的 ID 与 URL 中的 ID 一致

3. **确认权限**
   - 确保你的 Google 账号有权限访问这个 Sheet
   - 确保 Sheet 没有被删除或移动

### 4. 检查浏览器控制台

1. **打开开发者工具**
   - 按 `F12`
   - 切换到 **Console**（控制台）标签

2. **提交表单**

3. **查看控制台输出**
   - 应该看到：
     ```
     📤 Submitting to Google Sheets: {...}
     📥 Google Sheets response: {...}
     ✅ Google Sheets submission successful
     ```
   - 如果有错误，记录下来

### 5. 检查网络请求

1. **打开开发者工具**
   - 按 `F12`
   - 切换到 **Network**（网络）标签

2. **提交表单**

3. **查找请求**
   - 查找对 `script.google.com` 的 POST 请求
   - 点击查看详情

4. **检查请求和响应**
   - **请求**（Request）：
     - 查看 **Payload**（负载）标签
     - 确认 `jsonData` 参数存在
     - 确认数据格式正确
   - **响应**（Response）：
     - 查看状态码（应该是 200）
     - 查看响应内容
     - 应该看到 `{"success": true, ...}`

## 🔧 常见问题和解决方案

### 问题 1：执行日志显示 "No data received"

**可能原因：**
- 前端没有发送数据
- 数据格式不正确

**解决方法：**
1. 检查浏览器控制台，确认前端是否发送了请求
2. 检查网络请求的 Payload，确认数据存在
3. 检查 Code.gs 的数据解析逻辑

### 问题 2：执行日志显示 "Failed to parse data"

**可能原因：**
- 数据格式不匹配
- JSON 解析失败

**解决方法：**
1. 查看执行日志中的详细错误信息
2. 检查前端发送的数据格式
3. 确认 `jsonData` 参数是否正确编码

### 问题 3：执行日志显示 "Failed to access spreadsheet"

**可能原因：**
- SPREADSHEET_ID 错误
- 没有权限访问 Sheet
- Sheet 被删除或移动

**解决方法：**
1. 检查 SPREADSHEET_ID 是否正确
2. 确认 Sheet 存在且可访问
3. 确认你的账号有权限

### 问题 4：执行日志正常，但 Sheet 中没有数据

**可能原因：**
- Sheet 名称不匹配
- 数据转换失败
- appendRow 失败

**解决方法：**
1. 检查 SHEET_NAME 是否正确
2. 查看执行日志中的 "Data keys" 输出
3. 检查 convertDataToRow 函数

### 问题 5：前端显示成功，但实际未保存

**可能原因：**
- 前端误判为成功
- 后端实际失败但前端未检测到

**解决方法：**
1. 查看 Apps Script 执行日志
2. 检查网络请求的响应
3. 确认后端是否真的成功

## 📊 调试步骤

### 步骤 1：提交测试数据

1. 填写表单并提交
2. 记录提交时间

### 步骤 2：查看执行日志

1. 打开 Apps Script 执行日志
2. 找到对应时间的执行记录
3. 查看日志输出

### 步骤 3：分析日志

根据日志内容判断：

**如果看到 "=== Data Receiving Debug ==="：**
- ✅ 数据已收到
- 继续查看后续日志

**如果看到 "=== Data Parsed Successfully ==="：**
- ✅ 数据解析成功
- 查看 "Data keys" 确认字段正确

**如果看到 "Failed to parse data"：**
- ❌ 数据解析失败
- 查看错误详情

**如果看到 "Failed to access spreadsheet"：**
- ❌ Sheet 访问失败
- 检查 SPREADSHEET_ID 和权限

### 步骤 4：检查 Sheet

1. 打开 Google Sheets
2. 检查是否有新行
3. 如果有多张 Sheet，检查正确的 Sheet

## 🎯 快速诊断

### 诊断 1：测试 Web App

1. 在浏览器中直接访问 Web App URL
2. 应该看到：
   ```json
   {
     "success": true,
     "message": "Google Apps Script is running",
     ...
   }
   ```
3. 如果看到这个，说明 Web App 正常

### 诊断 2：测试数据提交

1. 使用浏览器开发者工具
2. 提交表单
3. 查看网络请求
4. 确认请求成功（状态码 200）
5. 查看响应内容

### 诊断 3：检查 Sheet 权限

1. 打开 Google Sheets
2. 点击右上角 **"共享"**
3. 确认你的账号有编辑权限
4. 如果使用服务账号，确认服务账号有权限

## 📝 需要提供的信息

如果问题仍然存在，请提供：

1. **Apps Script 执行日志**
   - 复制最近的执行日志内容

2. **浏览器控制台输出**
   - 截图或复制控制台输出

3. **网络请求详情**
   - 请求的 Payload
   - 响应的内容

4. **Code.gs 配置**
   - SPREADSHEET_ID（可以隐藏部分字符）
   - SHEET_NAME

5. **Web App 部署设置**
   - 执行身份
   - 访问权限

## ✅ 验证清单

修复后，确认：

- [ ] Apps Script 执行日志显示数据已接收
- [ ] 执行日志显示数据解析成功
- [ ] 执行日志显示数据已保存
- [ ] Google Sheets 中出现新行
- [ ] 新行数据正确
- [ ] 浏览器控制台显示成功消息

## 🆘 仍然无法解决？

如果按照以上步骤仍然无法解决：

1. **检查 Code.gs 是否已更新**
   - 确认最新的代码已复制到 Apps Script
   - 确认已保存

2. **重新部署 Web App**
   - 即使代码没变，也重新部署一次
   - 确保使用最新版本

3. **检查是否有其他错误**
   - 查看完整的执行日志
   - 检查是否有其他错误信息

4. **尝试测试函数**
   - 在 Apps Script 中运行 `testFunction`
   - 查看是否能成功保存测试数据

